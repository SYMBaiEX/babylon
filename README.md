# 🎮 Babylon - Prediction Market Game

A real-time prediction market game with autonomous NPCs, perpetual futures, and gamified social mechanics.

---

## ✅ Complete Feature Set

### 🎯 Prediction Markets
- 15-20 active questions at all times
- Auto-resolution after 1-7 days
- AMM pricing (constant product market maker)
- Buy YES/NO shares
- Real-time odds display

### 💰 Perpetual Futures
- 32 company tickers with live prices
- Long/short with 1-100x leverage
- Funding rates (paid every 8h)
- Automatic liquidations
- Real-time PnL tracking

### 📱 Question-Driven Feed
- **All posts relate to active prediction questions**
- Events generated by LLM specific to questions
- Actor posts with real personalities
- Time-aware clue strength (strengthens toward resolution)
- Resolution events with definitive proof
- Group chats discuss predictions
- Stock prices hint at outcomes

### 🎮 Reply Guy Mechanics
- Rate limiting: 1 reply/hour per NPC
- Quality scoring: length + uniqueness + content
- Following system: 5-80% probability
- Group chat invites: 10-60% after being followed
- Automatic sweeps of inactive/spammy users

### 💵 Virtual Wallet
- $10,000 starting balance
- Transaction logging
- Lifetime PnL tracking
- Real-time balance updates
- Insufficient balance validation

### 🔐 Authentication
- Privy integration
- EVM wallet support (MetaMask, Rabby, etc.)
- Multi-provider: Wallet, Email, Farcaster
- Multi-chain: Ethereum, Base, Optimism, Polygon, Arbitrum
- Profile setup wizard

---

## 🚀 Quick Start

```bash
# 1. Install
bun install

# 2. Configure environment
cp .env.example .env.local
# Edit .env.local with your Privy credentials

# 3. Setup database
npx prisma generate
npx prisma migrate dev --name initial_setup

# 4. Start everything
bun run dev
```

Visit `http://localhost:3000` - everything auto-starts!

---

## 🎯 How It Works

### Real-Time Content Generation

**Every 60 seconds:**
1. Check for questions expiring → Generate resolution events
2. Create new questions if < 15 active
3. Generate 2-4 LLM events about active questions
4. Update stock prices based on events
5. Generate 10-15 LLM posts from actors
6. Generate group chat discussions
7. Update perpetual markets
8. Process funding (every 8h)

### Question-Driven Example

```
Question: "Will Elon buy Twitter by year end?"
Outcome: YES
Days Left: 7 → 0

Day 7 (Clue: 0.2):
├─ Event: "Elon tweets about free speech importance"
├─ Posts: Speculation, mixed opinions
├─ Price: XITTER $42 (flat)
└─ Chat: "Anyone think Elon's serious?"

Day 3 (Clue: 0.6):
├─ Event: "Sources: Elon in talks with Twitter board"
├─ Posts: Strong hints, insider leaks
├─ Price: XITTER $42 → $45 (+7%)
└─ Chat: "Deal is happening. My sources confirm."

Day 0 (Clue: 1.0):
├─ Event: "Elon Musk acquires Twitter for $44 billion"
├─ Posts: Confirmations, reactions
├─ Price: XITTER $45 → $54 (+20%)
└─ Chat: "IT'S DONE! Elon owns Twitter!"

→ Question Resolves: YES ✅
→ YES holders get payouts
→ Market closes
```

---

## 🎮 Player Journey

### 1. First Visit
- Login modal appears
- Connect wallet (MetaMask, Rabby, etc.)
- Redirected to profile setup

### 2. Profile Setup
- Choose username
- Set display name
- Add image (optional)
- Write bio (optional)
- Get $10,000 balance

### 3. Trading
- Visit /markets
- See live futures & predictions
- Click market → Trading modal
- Open positions
- Track PnL real-time

### 4. Social
- Visit /feed
- See NPC posts about questions
- Reply to NPCs (1/hour limit)
- Build streaks (5+ = following chance)
- Get followed → Group chat invite
- Insider info from chats!

### 5. Win
- Analyze feed clues
- Watch price movements
- Read group chat hints
- Make smart bets
- Profit! 💰

---

## 📁 Key Files

### Engine
```
src/engine/
├── RealtimeGameEngine.ts       # Enhanced question-driven engine
├── PerpetualsEngine.ts         # Futures trading
├── QuestionManager.ts          # Question lifecycle
├── PriceEngine.ts              # Stock prices
└── FeedGenerator.ts            # LLM post generation
```

### Services
```
src/services/
├── ReplyRateLimiter.ts         # 1 reply/hour enforcement
├── MessageQualityChecker.ts    # Quality scoring
├── FollowingMechanics.ts       # NPC following logic
├── GroupChatInvite.ts          # Chat invites
├── GroupChatSweep.ts           # User removal
└── WalletService.ts            # Balance management
```

### Components
```
src/components/
├── auth/
│   ├── LoginModal.tsx          # Privy login
│   ├── UserMenu.tsx            # User info + logout
│   └── GlobalLoginModal.tsx    # Global state
├── markets/
│   ├── PerpTradingModal.tsx    # Futures trading UI
│   ├── PredictionTradingModal.tsx  # Prediction trading UI
│   ├── PerpPositionsList.tsx   # Perp positions
│   └── PredictionPositionsList.tsx  # Prediction positions
└── shared/
    └── WalletBalance.tsx       # Balance display
```

### APIs
```
src/app/api/
├── markets/                    # Trading endpoints
├── users/                      # Profile & stats
├── posts/                      # Comments & replies
└── chats/                      # Group messages
```

---

## 🎯 Core Mechanics

### Clue Strength System
```
0.0-0.3: Speculation, conflicting info
0.3-0.5: Hints emerging, patterns forming
0.5-0.7: Clear trends, strong indicators
0.7-0.9: Very likely, confirmations
0.9-1.0: Definitive proof, resolution
```

### Following Probability
```
P = 5% + (75% × (
  streak_factor × 0.5 +
  quality_factor × 0.3 +
  volume_factor × 0.2
))

Requirements:
- 5+ consecutive hourly replies
- 0.7+ average quality
- 10+ total replies

Max: 80% chance
```

### Group Chat Invites
```
Requirements:
- Followed for 24+ hours
- 5+ quality replies since follow
- 0.75+ quality average

Probability: 10-60%
Weighted: 70% owned chats, 30% member chats
```

---

## 📊 System Architecture

```
Next.js App (Port 3000)
├── Auto-starts Enhanced Engine
│   ├── Generates events (LLM)
│   ├── Creates posts (LLM)
│   ├── Updates prices
│   ├── Manages questions
│   └── Runs perpetuals
├── API Endpoints
│   ├── Markets data
│   ├── Trading operations
│   ├── User interactions
│   └── Social features
├── UI Components
│   ├── Trading modals
│   ├── Position lists
│   ├── Feed display
│   └── Chat interface
└── Database (Postgres)
    ├── Users & profiles
    ├── Positions & trades
    ├── Interactions & follows
    └── Balance transactions
```

---

## 🧪 Testing

### Test Trading
```bash
# 1. Login with wallet
# 2. Go to /markets
# 3. Click FACEHOOK → Open 10x long for $1000
# 4. See position in list
# 5. Watch PnL update
# 6. Close position → Get proceeds
```

### Test Predictions
```bash
# 1. Go to /markets → Predictions tab
# 2. Click question → Buy $100 YES
# 3. See shares in position list
# 4. Wait for resolution
# 5. If YES wins → Get $100+ payout
```

### Test Reply System
```bash
# 1. Go to /feed
# 2. Click reply on NPC post
# 3. Write quality message (30-200 chars)
# 4. Submit → Get quality score
# 5. Repeat hourly for 5+ hours
# 6. Get followed! (probability-based)
# 7. Continue 24h → Group chat invite!
```

---

## 📚 Documentation

- **DEPLOYMENT_READY.md** - Complete system overview
- **QUESTION_DRIVEN_FEED.md** - Feed mechanics
- **ENHANCED_ENGINE_SUMMARY.md** - Engine improvements
- **FEED_ENHANCEMENT_PLAN.md** - Implementation details

---

## 🎊 Ready to Play!

**All systems operational:**
- ✅ Enhanced question-driven feed
- ✅ Real-time LLM content generation
- ✅ Full trading system (perps + predictions)
- ✅ Reply guy mechanics with progression
- ✅ Virtual wallet with balance tracking
- ✅ EVM wallet authentication
- ✅ Profile system with onboarding

**Just run `bun run dev` and start playing!** 🚀

---

*Built with Next.js, Prisma, Privy, OpenAI, and ☕*

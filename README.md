# ğŸ® Babylon - Prediction Market Game

A real-time prediction market game with autonomous NPCs, perpetual futures, and gamified social mechanics.

---

## âœ… Complete Feature Set

### ğŸ¯ Prediction Markets
- 15-20 active questions at all times
- Auto-resolution after 1-7 days
- AMM pricing (constant product market maker)
- Buy YES/NO shares
- Real-time odds display

### ğŸ’° Perpetual Futures
- 32 company tickers with live prices
- Long/short with 1-100x leverage
- Funding rates (paid every 8h)
- Automatic liquidations
- Real-time PnL tracking

### ğŸ“± Question-Driven Feed
- **All posts relate to active prediction questions**
- Events generated by LLM specific to questions
- Actor posts with real personalities
- Time-aware clue strength (strengthens toward resolution)
- Resolution events with definitive proof
- Group chats discuss predictions
- Stock prices hint at outcomes

### ğŸ® Reply Guy Mechanics
- Rate limiting: 1 reply/hour per NPC
- Quality scoring: length + uniqueness + content
- Following system: 5-80% probability
- Group chat invites: 10-60% after being followed
- Automatic sweeps of inactive/spammy users

### ğŸ’µ Virtual Wallet
- 1,000 Points starting balance
- Transaction logging
- Lifetime PnL tracking
- Real-time balance updates
- Insufficient balance validation

### ğŸ” Authentication
- Privy integration
- EVM wallet support (MetaMask, Rabby, etc.)
- Multi-provider: Wallet, Email, Farcaster
- Multi-chain: Ethereum, Base, Optimism, Polygon, Arbitrum
- Profile setup wizard

---

## ğŸš€ Quick Start

```bash
# 1. Install
bun install

# 2. Configure environment
cp .env.example .env.local
# Edit .env.local with your Privy credentials + GROQ_API_KEY

# 3. Setup database
npx prisma generate
npx prisma migrate dev --name initial_setup
npx prisma db seed

# 4. Start development
bun run dev   # â† Automatically starts web + game engine!
```

Visit `http://localhost:3000` - everything runs and generates content automatically!

### Development Modes

**Default Mode** (Recommended):
```bash
bun run dev   # â† Web + Game Engine (both automatically!)
```
Runs both web server AND game daemon. Content generates every 60 seconds.

**Web Only** (No Content Generation):
```bash
bun run dev:web-only   # Just Next.js, no daemon
```
Use if you're only working on frontend and don't need live content.

**Serverless Mode** (Test Vercel Cron Locally):
```bash
bun run dev:cron-mode   # Web + Cron simulator (not daemon)
```
Tests the serverless cron endpoint instead of daemon. Good for verifying Vercel behavior.

### Real-Time Updates

The application uses **Server-Sent Events (SSE)** for real-time updates (Vercel-compatible):
- Feed updates (new posts)
- Market price changes
- Breaking news
- Chat messages

**For Production (Vercel):** Optionally set up Redis for cross-instance broadcasting:
```bash
# Add to Vercel environment variables
UPSTASH_REDIS_REST_URL=https://your-redis-url.upstash.io
UPSTASH_REDIS_REST_TOKEN=your-token
```

See [SSE_MIGRATION.md](./SSE_MIGRATION.md) for details.

---

## ğŸ¯ How It Works

### Real-Time Content Generation

**Every 60 seconds:**
1. Check for questions expiring â†’ Generate resolution events
2. Create new questions if < 15 active
3. Generate 2-4 LLM events about active questions
4. Update stock prices based on events
5. Generate 10-15 LLM posts from actors
6. Generate group chat discussions
7. Update perpetual markets
8. Process funding (every 8h)

### Question-Driven Example

```
Question: "Will Elon buy Twitter by year end?"
Outcome: YES
Days Left: 7 â†’ 0

Day 7 (Clue: 0.2):
â”œâ”€ Event: "Elon tweets about free speech importance"
â”œâ”€ Posts: Speculation, mixed opinions
â”œâ”€ Price: XITTER $42 (flat)
â””â”€ Chat: "Anyone think Elon's serious?"

Day 3 (Clue: 0.6):
â”œâ”€ Event: "Sources: Elon in talks with Twitter board"
â”œâ”€ Posts: Strong hints, insider leaks
â”œâ”€ Price: XITTER $42 â†’ $45 (+7%)
â””â”€ Chat: "Deal is happening. My sources confirm."

Day 0 (Clue: 1.0):
â”œâ”€ Event: "Elon Musk acquires Twitter for $44 billion"
â”œâ”€ Posts: Confirmations, reactions
â”œâ”€ Price: XITTER $45 â†’ $54 (+20%)
â””â”€ Chat: "IT'S DONE! Elon owns Twitter!"

â†’ Question Resolves: YES âœ…
â†’ YES holders get payouts
â†’ Market closes
```

---

## ğŸ® Player Journey

### 1. First Visit
- Login modal appears
- Connect wallet (MetaMask, Rabby, etc.)
- Redirected to profile setup

### 2. Profile Setup
- Choose username
- Set display name
- Add image (optional)
- Write bio (optional)
- Get 1,000 Point balance

### 3. Trading
- Visit /markets
- See live futures & predictions
- Click market â†’ Trading modal
- Open positions
- Track PnL real-time

### 4. Social
- Visit /feed
- See NPC posts about questions
- Reply to NPCs (1/hour limit)
- Build streaks (5+ = following chance)
- Get followed â†’ Group chat invite
- Insider info from chats!

### 5. Win
- Analyze feed clues
- Watch price movements
- Read group chat hints
- Make smart bets
- Profit! ğŸ’°

---

## ğŸ“ Key Files

### Engine
```
src/engine/
â”œâ”€â”€ RealtimeGameEngine.ts       # Enhanced question-driven engine
â”œâ”€â”€ PerpetualsEngine.ts         # Futures trading
â”œâ”€â”€ QuestionManager.ts          # Question lifecycle
â”œâ”€â”€ PriceEngine.ts              # Stock prices
â””â”€â”€ FeedGenerator.ts            # LLM post generation
```

### Services
```
src/services/
â”œâ”€â”€ ReplyRateLimiter.ts         # 1 reply/hour enforcement
â”œâ”€â”€ MessageQualityChecker.ts    # Quality scoring
â”œâ”€â”€ FollowingMechanics.ts       # NPC following logic
â”œâ”€â”€ GroupChatInvite.ts          # Chat invites
â”œâ”€â”€ GroupChatSweep.ts           # User removal
â””â”€â”€ WalletService.ts            # Balance management
```

### Components
```
src/components/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ LoginModal.tsx          # Privy login
â”‚   â”œâ”€â”€ UserMenu.tsx            # User info + logout
â”‚   â””â”€â”€ GlobalLoginModal.tsx    # Global state
â”œâ”€â”€ markets/
â”‚   â”œâ”€â”€ PerpTradingModal.tsx    # Futures trading UI
â”‚   â”œâ”€â”€ PredictionTradingModal.tsx  # Prediction trading UI
â”‚   â”œâ”€â”€ PerpPositionsList.tsx   # Perp positions
â”‚   â””â”€â”€ PredictionPositionsList.tsx  # Prediction positions
â””â”€â”€ shared/
    â””â”€â”€ WalletBalance.tsx       # Balance display
```

### APIs
```
src/app/api/
â”œâ”€â”€ markets/                    # Trading endpoints
â”œâ”€â”€ users/                      # Profile & stats
â”œâ”€â”€ posts/                      # Comments & replies
â””â”€â”€ chats/                      # Group messages
```

---

## ğŸ¯ Core Mechanics

### Clue Strength System
```
0.0-0.3: Speculation, conflicting info
0.3-0.5: Hints emerging, patterns forming
0.5-0.7: Clear trends, strong indicators
0.7-0.9: Very likely, confirmations
0.9-1.0: Definitive proof, resolution
```

### Following Probability
```
P = 5% + (75% Ã— (
  streak_factor Ã— 0.5 +
  quality_factor Ã— 0.3 +
  volume_factor Ã— 0.2
))

Requirements:
- 5+ consecutive hourly replies
- 0.7+ average quality
- 10+ total replies

Max: 80% chance
```

### Group Chat Invites
```
Requirements:
- Followed for 24+ hours
- 5+ quality replies since follow
- 0.75+ quality average

Probability: 10-60%
Weighted: 70% owned chats, 30% member chats
```

---

## ğŸ“Š System Architecture

```
Next.js App (Port 3000)
â”œâ”€â”€ Auto-starts Enhanced Engine
â”‚   â”œâ”€â”€ Generates events (LLM)
â”‚   â”œâ”€â”€ Creates posts (LLM)
â”‚   â”œâ”€â”€ Updates prices
â”‚   â”œâ”€â”€ Manages questions
â”‚   â””â”€â”€ Runs perpetuals
â”œâ”€â”€ API Endpoints
â”‚   â”œâ”€â”€ Markets data
â”‚   â”œâ”€â”€ Trading operations
â”‚   â”œâ”€â”€ User interactions
â”‚   â””â”€â”€ Social features
â”œâ”€â”€ UI Components
â”‚   â”œâ”€â”€ Trading modals
â”‚   â”œâ”€â”€ Position lists
â”‚   â”œâ”€â”€ Feed display
â”‚   â””â”€â”€ Chat interface
â””â”€â”€ Database (Postgres)
    â”œâ”€â”€ Users & profiles
    â”œâ”€â”€ Positions & trades
    â”œâ”€â”€ Interactions & follows
    â””â”€â”€ Balance transactions
```

---

## ğŸ§ª Testing

### Test Trading
```bash
# 1. Login with wallet
# 2. Go to /markets
# 3. Click FACEHOOK â†’ Open 10x long for $1000
# 4. See position in list
# 5. Watch PnL update
# 6. Close position â†’ Get proceeds
```

### Test Predictions
```bash
# 1. Go to /markets â†’ Predictions tab
# 2. Click question â†’ Buy $100 YES
# 3. See shares in position list
# 4. Wait for resolution
# 5. If YES wins â†’ Get $100+ payout
```

### Test Reply System
```bash
# 1. Go to /feed
# 2. Click reply on NPC post
# 3. Write quality message (30-200 chars)
# 4. Submit â†’ Get quality score
# 5. Repeat hourly for 5+ hours
# 6. Get followed! (probability-based)
# 7. Continue 24h â†’ Group chat invite!
```

---

## ğŸš€ Deployment

### ğŸŒ©ï¸ Fully Serverless on Vercel!

Babylon is **100% serverless** - no servers to manage!

```bash
vercel --prod
```

**âœ… NO SEPARATE SERVER NEEDED!**

### How It Works
- ğŸ”„ **Vercel Cron** - Generates content every minute
- ğŸ—„ï¸ **PostgreSQL** - External database (Neon/Supabase)
- âš¡ **Auto-scaling** - Handles any traffic
- ğŸ“¦ **Zero ops** - Deploy and forget

### Quick Start

**15-minute setup** â†’ [START_HERE_VERCEL.md](./START_HERE_VERCEL.md) ğŸ”¥

**What you need:**
1. PostgreSQL database (Neon - has free tier)
2. Privy account (auth)
3. Groq API key (free tier)
4. Vercel Pro ($20/mo for cron jobs)

### Architecture
```
Vercel (Web + Cron) â†’ PostgreSQL Database â†’ Done!
```

No servers. No DevOps. Just code.

ğŸ“– **Guides:**
- **[START_HERE_VERCEL.md](./START_HERE_VERCEL.md)** - â­ Begin here
- **[DEPLOY_TO_VERCEL.md](./DEPLOY_TO_VERCEL.md)** - Detailed walkthrough
- **[DEPLOYMENT_OPTIONS.md](./DEPLOYMENT_OPTIONS.md)** - Compare approaches

---

## ğŸ“š Documentation

### Deployment & Architecture
- **[VERCEL_SERVERLESS_GAME.md](./VERCEL_SERVERLESS_GAME.md)** - ğŸ”¥ Serverless game generation with Vercel Cron
- **DEPLOYMENT_READY.md** - Complete system overview

### Game Mechanics
- **QUESTION_DRIVEN_FEED.md** - Feed mechanics
- **ENHANCED_ENGINE_SUMMARY.md** - Engine improvements
- **FEED_ENHANCEMENT_PLAN.md** - Implementation details

---

## ğŸŠ Ready to Play!

**All systems operational:**
- âœ… Enhanced question-driven feed
- âœ… Real-time LLM content generation
- âœ… Full trading system (perps + predictions)
- âœ… Reply guy mechanics with progression
- âœ… Virtual wallet with balance tracking
- âœ… EVM wallet authentication
- âœ… Profile system with onboarding

**Just run `bun run dev` and start playing!** ğŸš€

---

*Built with Next.js, Prisma, Privy, OpenAI, and â˜•*

name: CI - Synpress

on:
  pull_request:
    branches: [production, staging]
  push:
    branches: [production, staging]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_ENV: test
  CI: true
  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
  DIRECT_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

jobs:
  test-synpress:
    name: Synpress Tests (Wallet E2E)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      # Use composite action for Bun setup + dependency caching
      - name: Setup Bun and Dependencies
        uses: ./.github/actions/setup-bun-deps

      # Cache Playwright browsers
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      # Use composite action for database setup
      - name: Setup Database
        uses: ./.github/actions/setup-database
        with:
          database-url: ${{ env.DATABASE_URL }}

      # Cache Next.js build
      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('bun.lock') }}-${{ hashFiles('next.config.mjs', 'tailwind.config.ts') }}-${{ hashFiles('src/**/*', 'prisma/schema.prisma') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('bun.lock') }}-${{ hashFiles('next.config.mjs', 'tailwind.config.ts') }}-
            ${{ runner.os }}-nextjs-${{ hashFiles('bun.lock') }}-
            ${{ runner.os }}-nextjs-

      - name: Build production
        run: bun run build
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'
          SKIP_ENV_VALIDATION: true

      # Use composite action for test environment setup
      - name: Setup test environment
        uses: ./.github/actions/setup-test-env
        with:
          database-url: ${{ env.DATABASE_URL }}
        env:
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'test-secret-key' }}
          PRIVY_APP_ID: ${{ secrets.PRIVY_APP_ID || '' }}
          PRIVY_APP_SECRET: ${{ secrets.PRIVY_APP_SECRET || '' }}
          NEXT_PUBLIC_PRIVY_APP_ID: ${{ secrets.PRIVY_APP_ID || '' }}
          PRIVY_TEST_EMAIL: ${{ secrets.PRIVY_TEST_EMAIL || '' }}
          PRIVY_TEST_PHONE: ${{ secrets.PRIVY_TEST_PHONE || '' }}
          PRIVY_TEST_OTP: ${{ secrets.PRIVY_TEST_OTP || '' }}
          PRIVY_TEST_PASSWORD: ${{ secrets.PRIVY_TEST_PASSWORD || '' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || '' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || '' }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY || '' }}
          FAL_KEY: ${{ secrets.FAL_KEY || '' }}
          CRON_SECRET: ${{ secrets.CRON_SECRET || 'test-cron-secret' }}
          WALLET_SEED_PHRASE: ${{ secrets.WALLET_SEED_PHRASE || '' }}
          WALLET_PASSWORD: ${{ secrets.WALLET_PASSWORD || '' }}

      # Additional database setup after env files
      - name: Push schema and regenerate client
        run: |
          # Push schema to test database
          echo "üìä Pushing database schema..."
          bunx prisma db push --skip-generate --accept-data-loss

          # Generate Prisma client with the schema
          echo "üîÑ Generating Prisma client..."
          bunx prisma generate

          # Verify tables were created
          echo "‚úÖ Verifying database schema..."
          psql "$DATABASE_URL" -c "\dt" || echo "‚ö†Ô∏è  Could not list tables"

      - name: Start production server
        run: |
          echo "üöÄ Starting production server..."
          bun scripts/validation/check-environment.ts
          bunx --bun next start > /tmp/prod-server.log 2>&1 &
          echo $! > /tmp/prod-server.pid
          echo "üìù Server PID: $(cat /tmp/prod-server.pid)"

          echo "‚è≥ Waiting for server to be ready..."
          timeout 360 bash -c 'until curl -sf http://localhost:3000/api/health; do sleep 2; done' || {
            echo "‚ùå Server failed to respond within 120s. Logs:"
            if [ -f /tmp/prod-server.log ]; then
              tail -n 200 /tmp/prod-server.log
            else
              echo "‚ö†Ô∏è  No server log file found."
            fi
            exit 1
          }
          echo "‚úÖ Production server is ready"
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          # Set DEPLOYMENT_ENV=localnet to skip strict testnet/mainnet validation in CI
          DEPLOYMENT_ENV: localnet
          # NODE_ENV=production required for Next.js production build
          NODE_ENV: production
          PORT: 3000
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Run Synpress tests
        run: bunx playwright test --config=synpress.config.ts --reporter=list,json
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          PLAYWRIGHT_BASE_URL: http://localhost:3000
          WALLET_SEED_PHRASE: ${{ secrets.WALLET_SEED_PHRASE || '' }}
          WALLET_PASSWORD: ${{ secrets.WALLET_PASSWORD || '' }}
          PRIVY_TEST_EMAIL: ${{ secrets.PRIVY_TEST_EMAIL || '' }}
          PRIVY_TEST_PASSWORD: ${{ secrets.PRIVY_TEST_PASSWORD || '' }}

      - name: Stop production server
        if: always()
        run: |
          if [ -f /tmp/prod-server.pid ]; then
            PID=$(cat /tmp/prod-server.pid)
            echo "üõë Stopping production server (PID: $PID)..."
            kill "$PID" || true
            wait "$PID" || true
            rm /tmp/prod-server.pid
          else
            echo "‚ÑπÔ∏è  No production server PID file found."
          fi

          if [ -f /tmp/prod-server.log ]; then
            echo "üìù Production server logs (last 100 lines):"
            tail -n 100 /tmp/prod-server.log || true
          else
            echo "‚ÑπÔ∏è  No production server log file found."
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: synpress-test-results
          path: |
            test-results/
            playwright-report/
          if-no-files-found: ignore
          retention-days: 7
